#!/usr/bin/env bash
# appreciate-memory â€” Bump a memory's appreciation score
# Usage: appreciate-memory memory/<name>.md <int>
set -euo pipefail

AGENT_DIR="${CLAUDE_PROJECT_DIR:-.}"

if [[ $# -ne 2 ]]; then
  echo "Error: expected exactly 2 arguments." >&2
  echo "Usage: appreciate-memory memory/<name>.md <int>" >&2
  exit 1
fi

TARGET="$1"
AMOUNT="$2"

if [[ ! "$TARGET" =~ ^memory/[a-z0-9-]+\.md$ ]]; then
  echo "Error: first argument must match 'memory/<kebab-case-name>.md'" >&2
  echo "Got: $TARGET" >&2
  exit 1
fi

if [[ ! "$AMOUNT" =~ ^[0-9]+$ ]] || [[ "$AMOUNT" -eq 0 ]]; then
  echo "Error: second argument must be a positive integer" >&2
  echo "Got: $AMOUNT" >&2
  exit 1
fi

MEM_FILE="${AGENT_DIR}/${TARGET}"

if [[ ! -f "$MEM_FILE" ]]; then
  echo "Error: $TARGET does not exist" >&2
  exit 1
fi

NEW_SCORE=$(python3 -c "
import sys
sys.path.insert(0, '${AGENT_DIR}/src')
from memory_metadata import read_metadata, write_metadata
from pathlib import Path
f = Path('${MEM_FILE}')
meta = read_metadata(f)
meta['appreciation'] = meta.get('appreciation', 0) + ${AMOUNT}
write_metadata(f, meta)
print(meta['appreciation'])
")
echo "Bumped appreciation of ${TARGET} by +${AMOUNT} (now ${NEW_SCORE})"

# Notify terminal
if [[ -n "${AGENT_TERMINAL_PID:-}" ]] && command -v st-notify &>/dev/null; then
  st-notify -t 16000 -ts 18 -b "#ff6b9d" -bg "#1a0010" -fg "#f1faee" \
    "$AGENT_TERMINAL_PID" "Kept ${TARGET} (+${AMOUNT})" &>/dev/null || true
fi
